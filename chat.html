<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Soporte en Línea</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <div id="chatWindow" class="chat-window">
        <div class="chat-header">
            <strong>Soporte al Cliente</strong>
            <div id="connectionStatus" class="status-indicator status-waiting" title="Conectando..."></div>
        </div>
        <div id="messagesContainer" class="messages-container">
            <div class="loading">Conectando al chat...</div>
        </div>
        <div class="input-area">
            <input type="text" id="messageInput" placeholder="Escribe tu mensaje..." disabled>
            <button id="sendMessageBtn" disabled>Enviar</button>
        </div>
    </div>
    
    <div id="errorContainer" style="text-align: center; padding: 40px; display: none;">
        <h1>Enlace no válido</h1>
        <p>Por favor, asegúrate de usar el enlace de chat que te proporcionaron.</p>
        <button onclick="window.location.href = window.location.origin" style="margin-top: 20px; padding: 10px 20px;">
            Volver al Inicio
        </button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="config.js"></script>

    <script>
        // --- INICIALIZACIÓN ---
        firebase.initializeApp(getFirebaseConfig());
        const db = firebase.database();

        // --- ELEMENTOS DEL DOM ---
        const chatWindow = document.getElementById('chatWindow');
        const errorContainer = document.getElementById('errorContainer');
        const messagesContainer = document.getElementById('messagesContainer');
        const messageInput = document.getElementById('messageInput');
        const sendMessageBtn = document.getElementById('sendMessageBtn');
        const connectionStatus = document.getElementById('connectionStatus');

        // --- VARIABLES GLOBALES ---
        let chatId = null;
        let messagesRef = null;
        let isConnected = false;

        // --- VALIDACIÓN INICIAL ---
        const params = new URLSearchParams(window.location.search);
        chatId = params.get('id');

        if (!chatId) {
            showError();
        } else {
            validateChatAccess();
        }

        function validateChatAccess() {
            // Verificar si el chat existe y es accesible
            const chatKeyRef = db.ref(`chatKeys/${chatId}`);
            const chatRef = db.ref(`chats/${chatId}`);
            
            chatKeyRef.once('value').then((keySnapshot) => {
                if (!keySnapshot.exists()) {
                    showError('Chat no encontrado o acceso denegado');
                    return;
                }
                
                chatRef.once('value').then((chatSnapshot) => {
                    if (!chatSnapshot.exists()) {
                        showError('El chat no existe');
                        return;
                    }
                    
                    // Chat válido, inicializar
                    initializeChat();
                });
            }).catch(error => {
                console.error('Validation error:', error);
                showError('Error de conexión');
            });
        }

        function initializeChat() {
            messagesRef = db.ref(`chats/${chatId}/messages`);
            const metadataRef = db.ref(`chats/${chatId}/metadata`);
            
            // Configurar listener de mensajes
            messagesRef.orderByChild('timestamp').on('value', (snapshot) => {
                messagesContainer.innerHTML = '';
                const messages = snapshot.val();
                
                if (!messages) {
                    messagesContainer.innerHTML = '<div class="loading">No hay mensajes aún. ¡Envía el primero!</div>';
                    return;
                }
                
                const messagesArray = Object.entries(messages)
                    .sort((a, b) => a[1].timestamp - b[1].timestamp);
                
                let hasMessages = false;
                messagesArray.forEach(([msgId, msg]) => {
                    addMessageToUI(msg.text, msg.sender, msg.timestamp);
                    hasMessages = true;
                });
                
                if (hasMessages) {
                    scrollToBottom();
                }
            });
            
            // Actualizar metadata del chat
            metadataRef.update({
                lastActivity: Date.now(),
                status: 'active',
                unreadCount: firebase.database.ServerValue.increment(1)
            });
            
            // Habilitar UI
            enableChatUI();
            updateConnectionStatus(true);
            
            // Configurar conexión
            setupConnectionMonitoring();
        }

        function addMessageToUI(text, sender, timestamp) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const timeString = formatTime(timestamp, true);
            messageDiv.innerHTML = `
                ${text}
                <div class="message-time">${timeString}</div>
            `;
            
            messagesContainer.appendChild(messageDiv);
        }

        function sendMessage() {
            const text = messageInput.value.trim();
            if (!text || !chatId) return;
            
            // Deshabilitar temporalmente
            messageInput.disabled = true;
            sendMessageBtn.disabled = true;
            
            messagesRef.push({
                text: text,
                sender: 'user',
                timestamp: Date.now()
            }).then(() => {
                messageInput.value = '';
                messageInput.disabled = false;
                sendMessageBtn.disabled = false;
                messageInput.focus();
                
                // Actualizar última actividad
                db.ref(`chats/${chatId}/metadata`).update({
                    lastActivity: Date.now(),
                    status: 'active'
                });
            }).catch(error => {
                console.error('Error sending message:', error);
                alert('Error al enviar el mensaje. Intenta nuevamente.');
                messageInput.disabled = false;
                sendMessageBtn.disabled = false;
            });
        }

        function enableChatUI() {
            messageInput.disabled = false;
            sendMessageBtn.disabled = false;
            messageInput.focus();
            
            // Remover loading
            const loadingElement = messagesContainer.querySelector('.loading');
            if (loadingElement) {
                loadingElement.remove();
            }
        }

        function updateConnectionStatus(connected) {
            isConnected = connected;
            connectionStatus.className = `status-indicator ${connected ? 'status-active' : 'status-waiting'}`;
            connectionStatus.title = connected ? 'Conectado' : 'Conectando...';
        }

        function setupConnectionMonitoring() {
            const connectedRef = db.ref(".info/connected");
            connectedRef.on("value", (snap) => {
                updateConnectionStatus(snap.val() === true);
            });
        }

        function formatTime(timestamp, includeTime = false) {
            if (!timestamp) return '';
            
            const date = new Date(timestamp);
            if (includeTime) {
                return date.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
            }
            return date.toLocaleDateString('es-ES');
        }

        function scrollToBottom() {
            setTimeout(() => {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 100);
        }

        function showError(message = 'Enlace no válido') {
            chatWindow.style.display = 'none';
            errorContainer.style.display = 'block';
            
            if (message) {
                errorContainer.querySelector('p').textContent = message;
            }
        }

        // --- EVENT LISTENERS ---
        sendMessageBtn.onclick = sendMessage;
        messageInput.onkeypress = (e) => {
            if (e.key === 'Enter') sendMessage();
        };

        // Manejar visibilidad de la página
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && chatId) {
                // Actualizar actividad cuando la pestaña se vuelve visible
                db.ref(`chats/${chatId}/metadata/lastActivity`).set(Date.now());
            }
        });

    </script>
</body>
</html>