<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Soporte en Línea Seguro</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
</head>
<body>

    <main id="mainContent" class="main-content-centered">
        <div id="loadingScreen" class="status-screen">
            <div class="spinner"></div>
            <h1>Conectando al chat seguro...</h1>
            <p>Por favor, espera un momento.</p>
        </div>

        <div id="errorScreen" class="status-screen" style="display: none;">
            <i class="fas fa-exclamation-triangle error-icon"></i>
            <h1>Error de Conexión</h1>
            <p>Asegúrate de tener el enlace correcto o solicita uno nuevo al agente de soporte.</p>
        </div>

        <div id="chatWindow" class="chat-window" style="display: none;">
            <div class="chat-header">
                <strong><i class="fas fa-headset"></i> Soporte al Cliente</strong>
                <div id="connectionStatus" class="status-indicator" title="Estado de la conexión"></div>
            </div>
            
            <div id="messagesContainer" class="messages-container">
                <!-- Los mensajes se cargarán aquí -->
            </div>

            <div id="statusMessage" class="chat-status-message">
                <span><i class="fas fa-circle-info"></i> El chat está activo. Un agente responderá pronto.</span>
            </div>

            <div class="chat-input-area">
                <textarea id="messageInput" placeholder="Escribe tu mensaje..." rows="1" maxlength="500"></textarea>
                <button id="sendMessageBtn" class="send-button" disabled><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </main>

    <!-- Librerías de Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <!-- Librerías de Cifrado -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    
    <!-- Archivos locales -->
    <script src="config.js"></script>
    <script src="crypto-helpers.js"></script>

    <script>
        // Inicialización de Firebase
        const firebaseConfig = getFirebaseConfig();
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        
        // Elementos del DOM
        const loadingScreen = document.getElementById('loadingScreen');
        const errorScreen = document.getElementById('errorScreen');
        const chatWindow = document.getElementById('chatWindow');
        const messagesContainer = document.getElementById('messagesContainer');
        const messageInput = document.getElementById('messageInput');
        const sendMessageBtn = document.getElementById('sendMessageBtn');
        const connectionStatus = document.getElementById('connectionStatus');
        const statusMessage = document.getElementById('statusMessage');

        let chatId;
        let messagesRef;
        let metadataRef;
        let chatInitialized = false;

        document.addEventListener('DOMContentLoaded', initializeChat);
        
        // Función de utilidad para manejar errores
        function showError(message) {
            loadingScreen.style.display = 'none';
            chatWindow.style.display = 'none';
            errorScreen.style.display = 'flex';
            if(message) errorScreen.querySelector('p').textContent = message;
        }

        function getChatIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }

        function initializeChat() {
            chatId = getChatIdFromUrl();
            if (!chatId) {
                showError('El enlace de chat no es válido.');
                return;
            }
            
            try {
                // Verificar que las funciones de cifrado estén disponibles
                if (typeof encryptMessage !== 'function' || typeof decryptMessage !== 'function') {
                    throw new Error("No se cargaron las funciones de cifrado.");
                }
                
                messagesRef = db.ref(`chats/${chatId}/messages`);
                metadataRef = db.ref(`chats/${chatId}/metadata`);
                
                // 1. Verificar si el chat existe y cargar los datos
                metadataRef.once('value', snapshot => {
                    if (!snapshot.exists()) {
                        showError('El chat no existe o el enlace ha caducado.');
                        return;
                    }
                    
                    // Inicialización exitosa
                    chatInitialized = true;
                    loadingScreen.style.display = 'none';
                    chatWindow.style.display = 'flex';
                    
                    // 2. Establecer listeners de datos
                    setupMessageListener();
                    setupMetadataListener();
                    setupConnectionMonitoring();
                    
                    // Habilitar el envío de mensajes
                    sendMessageBtn.disabled = false;
                    
                }, (error) => {
                    // Manejar errores de permisos o de red al intentar leer la metadata
                    console.error("Error al acceder a la metadata:", error.code, error.message);
                    if (error.code === 'PERMISSION_DENIED') {
                        // Con las reglas de seguridad actualizadas, esto debería fallar si el chatId es incorrecto.
                        showError('No tienes permiso para acceder a este chat. Revisa el enlace.');
                    } else {
                        showError('Error de conexión con la base de datos.');
                    }
                });

            } catch (e) {
                console.error("Error de inicialización:", e);
                showError('Error interno del sistema de chat. Por favor, inténtalo más tarde.');
            }
        }
        
        function setupMessageListener() {
             messagesRef.on('child_added', snapshot => {
                const message = snapshot.val();
                try {
                    // Usamos el chatId como clave para el descifrado
                    message.text = decryptMessage(message.text, chatId);
                } catch (e) {
                    console.warn("Error de descifrado, mensaje omitido o corrupto:", e);
                    // Omitir mensaje corrupto o mostrar un indicador de error
                    message.text = "[Error: Mensaje corrupto]";
                }
                displayMessage(message);
            });
        }

        function setupMetadataListener() {
            // Escuchar cambios en el estado del chat
            metadataRef.child('status').on('value', snapshot => {
                const status = snapshot.val();
                updateChatStatus(status);
                // Si el chat está cerrado, deshabilitar el input
                sendMessageBtn.disabled = status === 'closed' || !chatInitialized;
                messageInput.disabled = status === 'closed';
                messageInput.placeholder = status === 'closed' ? 'Este chat ha sido cerrado por el agente.' : 'Escribe tu mensaje...';
            });
            
            // Actualizar contador de mensajes no leídos del agente (al cliente no le importa el suyo propio)
            // Se asume que el cliente ha leído todos los mensajes al abrir la ventana.
            // Para simplificar, actualizaremos 'unreadByAgent' a 0 después de que se carguen los mensajes.
            messagesRef.once('value').then(() => {
                metadataRef.child('unreadByAgent').set(0).catch(err => {
                    console.error("No se pudo actualizar el contador de no leídos:", err);
                });
            });
        }
        
        function updateChatStatus(status) {
            let message = '';
            let icon = '';
            
            switch (status) {
                case 'open':
                    message = 'El chat está activo. Un agente responderá pronto.';
                    icon = 'fas fa-circle-info';
                    statusMessage.style.backgroundColor = 'var(--bg-white)';
                    statusMessage.style.color = 'var(--text-secondary)';
                    break;
                case 'in_progress':
                    message = 'Estás chateando con un agente. ¡Hola!';
                    icon = 'fas fa-user-tie';
                    statusMessage.style.backgroundColor = 'var(--success-color-light)';
                    statusMessage.style.color = 'var(--text-primary)';
                    break;
                case 'closed':
                    message = 'Este chat ha sido cerrado. Puedes crear uno nuevo si necesitas más ayuda.';
                    icon = 'fas fa-ban';
                    statusMessage.style.backgroundColor = 'var(--error-color-light)';
                    statusMessage.style.color = 'var(--text-primary)';
                    break;
                default:
                    message = 'Estado del chat desconocido.';
                    icon = 'fas fa-question-circle';
                    statusMessage.style.backgroundColor = 'var(--bg-white)';
                    statusMessage.style.color = 'var(--text-secondary)';
            }
            statusMessage.innerHTML = `<span><i class="${icon}"></i> ${message}</span>`;
            statusMessage.style.display = 'flex';
        }


        function displayMessage(message) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message-bubble', message.sender === 'user' ? 'user-message' : 'agent-message');
            
            const textElement = document.createElement('p');
            textElement.textContent = message.text;
            messageElement.appendChild(textElement);
            
            const timeElement = document.createElement('span');
            timeElement.classList.add('message-time');
            timeElement.textContent = formatTime(message.timestamp);
            messageElement.appendChild(timeElement);

            messagesContainer.appendChild(messageElement);
            scrollToBottom();
        }

        function sendMessage() {
            const text = messageInput.value.trim();
            if (text === '' || !chatInitialized) return;
            
            // Deshabilitar botón temporalmente para evitar spam
            sendMessageBtn.disabled = true;
            messageInput.disabled = true;
            
            messageInput.value = '';

            try {
                // Usamos el chatId como clave para el cifrado
                const encryptedText = encryptMessage(text, chatId);
                
                const newMessage = {
                    text: encryptedText,
                    sender: 'user', // El cliente anónimo es siempre 'user'
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                };

                // Añadir el mensaje y luego manejar la actualización de metadata
                messagesRef.push(newMessage)
                    .then(() => {
                        // Éxito: re-habilitar el input
                        sendMessageBtn.disabled = false;
                        messageInput.disabled = false;
                        messageInput.focus();
                        
                        // Actualizar contadores y actividad
                        return metadataRef.update({
                            lastActivity: firebase.database.ServerValue.TIMESTAMP,
                            unreadByAgent: firebase.database.ServerValue.increment(1) // Notificar al agente
                        });
                    })
                    .catch(error => {
                        console.error('Error al enviar mensaje:', error);
                        // FIX: Usar showError en lugar de alert()
                        showError('No se pudo enviar el mensaje. Inténtalo de nuevo.'); 
                        // Restaurar el texto y re-habilitar
                        messageInput.value = text;
                        sendMessageBtn.disabled = false;
                        messageInput.disabled = false;
                    });
                    
            } catch (error) {
                console.error('Error al enviar mensaje (cifrado):', error);
                showError('Error de cifrado. No se pudo procesar el mensaje.');
                messageInput.value = text;
                sendMessageBtn.disabled = false;
                messageInput.disabled = false;
            }
        }
        
        function setupConnectionMonitoring() {
            const connectedRef = db.ref(".info/connected");
            connectedRef.on("value", (snap) => {
                const isConnected = snap.val() === true;
                connectionStatus.className = `status-indicator ${isConnected ? 'status-active' : 'status-waiting'}`;
                connectionStatus.title = isConnected ? 'Conectado' : 'Reconectando...';
            });
        }

        function formatTime(timestamp) {
            if (!timestamp) return '';
            return new Date(timestamp).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
        }

        function scrollToBottom() {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Ya existe y se usa en showError()
        // function showError(message) { /* ... */ } 

        sendMessageBtn.onclick = sendMessage;
        messageInput.onkeypress = (e) => { 
            if (e.key === 'Enter' && !e.shiftKey) { 
                e.preventDefault(); 
                sendMessage(); 
            }
        };
        
        // Ajustar el textarea automáticamente
        messageInput.oninput = function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        };
        
    </script>
</body>
</html>
