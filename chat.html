<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Soporte en Línea Seguro</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <div id="chatWindow" class="chat-window">
        <div class="chat-header">
            <strong>Soporte al Cliente (Cifrado)</strong>
            <div id="connectionStatus" class="status-indicator status-waiting" title="Conectando..."></div>
        </div>
        <div id="messagesContainer" class="messages-container">
            <div class="loading">Conectando al chat seguro...</div>
        </div>
        <div class="input-area">
            <input type="text" id="messageInput" placeholder="Escribe tu mensaje cifrado..." disabled>
            <button id="sendMessageBtn" disabled>Enviar</button>
        </div>
    </div>
    
    <div id="errorContainer" style="text-align: center; padding: 40px; display: none;">
        <h1>Enlace no válido o caducado</h1>
        <p>Por favor, asegúrate de usar el enlace de chat correcto que te proporcionaron.</p>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <!-- Librería de Cifrado -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

    <!-- Scripts de la Aplicación -->
    <script src="config.js"></script>
    <script src="crypto-helpers.js"></script>

    <script>
        // --- INICIALIZACIÓN ---
        firebase.initializeApp(getFirebaseConfig());
        const db = firebase.database();

        const chatWindow = document.getElementById('chatWindow');
        const errorContainer = document.getElementById('errorContainer');
        const messagesContainer = document.getElementById('messagesContainer');
        const messageInput = document.getElementById('messageInput');
        const sendMessageBtn = document.getElementById('sendMessageBtn');
        const connectionStatus = document.getElementById('connectionStatus');

        let chatId = null;
        let messagesRef = null;

        // --- VALIDACIÓN INICIAL ---
        const params = new URLSearchParams(window.location.search);
        chatId = params.get('id');

        if (!chatId) {
            showError();
        } else {
            validateChatAccess();
        }

        function validateChatAccess() {
            const chatKeyRef = db.ref(`chatKeys/${chatId}`);
            chatKeyRef.once('value').then((keySnapshot) => {
                if (!keySnapshot.exists()) {
                    showError('Chat no encontrado o acceso denegado.');
                    return;
                }
                initializeChat();
            }).catch(error => {
                console.error('Validation error:', error);
                showError('Error de conexión.');
            });
        }

        function initializeChat() {
            messagesRef = db.ref(`chats/${chatId}/messages`);
            const metadataRef = db.ref(`chats/${chatId}/metadata`);
            
            messagesRef.orderByChild('timestamp').on('value', (snapshot) => {
                messagesContainer.innerHTML = '';
                const messages = snapshot.val();
                
                if (!messages) {
                    messagesContainer.innerHTML = '<div class="loading">Aún no hay mensajes. ¡Envía el primero!</div>';
                    return;
                }
                
                const messagesArray = Object.values(messages).sort((a, b) => a.timestamp - b.timestamp);
                
                messagesArray.forEach(msg => {
                    addMessageToUI(msg.text, msg.sender, msg.timestamp);
                });
                scrollToBottom();
            });
            
            metadataRef.update({
                lastActivity: Date.now(),
                status: 'active',
                unreadCount: firebase.database.ServerValue.increment(1)
            });
            
            enableChatUI();
            setupConnectionMonitoring();
        }

        function addMessageToUI(encryptedText, sender, timestamp) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            let plainText = '';

            try {
                // *** DESCIFRADO DEL MENSAJE ***
                plainText = decryptMessage(encryptedText, chatId);
            } catch (e) {
                console.warn("No se pudo descifrar un mensaje:", e);
                plainText = "<i>[Mensaje no descifrable o antiguo]</i>";
            }

            const timeString = formatTime(timestamp);
            messageDiv.innerHTML = `
                ${plainText}
                <div class="message-time">${timeString}</div>
            `;
            messagesContainer.appendChild(messageDiv);
        }

        function sendMessage() {
            const text = messageInput.value.trim();
            if (!text || !chatId) return;
            
            messageInput.disabled = true;
            sendMessageBtn.disabled = true;

            // *** CIFRADO DEL MENSAJE ***
            const encryptedText = encryptMessage(text, chatId);
            
            messagesRef.push({
                text: encryptedText, // Guardamos el texto cifrado
                sender: 'user',
                timestamp: Date.now()
            }).then(() => {
                messageInput.value = '';
                db.ref(`chats/${chatId}/metadata`).update({
                    lastActivity: Date.now(),
                    status: 'active'
                });
            }).catch(error => {
                console.error('Error sending message:', error);
                alert('Error al enviar el mensaje. Intenta nuevamente.');
            }).finally(() => {
                messageInput.disabled = false;
                sendMessageBtn.disabled = false;
                messageInput.focus();
            });
        }

        function enableChatUI() {
            messageInput.disabled = false;
            sendMessageBtn.disabled = false;
            messageInput.focus();
            const loadingElement = messagesContainer.querySelector('.loading');
            if (loadingElement) loadingElement.remove();
        }
        
        function setupConnectionMonitoring() {
            const connectedRef = db.ref(".info/connected");
            connectedRef.on("value", (snap) => {
                const isConnected = snap.val() === true;
                connectionStatus.className = `status-indicator ${isConnected ? 'status-active' : 'status-waiting'}`;
                connectionStatus.title = isConnected ? 'Conectado' : 'Reconectando...';
            });
        }

        function formatTime(timestamp) {
            if (!timestamp) return '';
            return new Date(timestamp).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
        }

        function scrollToBottom() {
            setTimeout(() => messagesContainer.scrollTop = messagesContainer.scrollHeight, 100);
        }

        function showError(message = 'Enlace no válido') {
            chatWindow.style.display = 'none';
            errorContainer.style.display = 'block';
            errorContainer.querySelector('p').textContent = message;
        }

        // --- EVENT LISTENERS ---
        sendMessageBtn.onclick = sendMessage;
        messageInput.onkeypress = (e) => { if (e.key === 'Enter') sendMessage(); };
    </script>
</body>
</html>
