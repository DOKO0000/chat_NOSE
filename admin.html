[file name]: admin.html
[file content begin]
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Agente - Soporte Seguro</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <div class="dashboard-container">
        <div class="sidebar">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2>Chats Activos</h2>
                <button id="logoutBtn" style="padding: 5px 10px; cursor: pointer;">Salir</button>
            </div>
            <button id="createChatBtn" class="new-chat-btn">Crear Nuevo Chat Seguro</button>
            <div id="loadingChats" class="loading">Cargando chats...</div>
            <div id="chatList" class="chat-list" style="display: none;"></div>
            <div id="noChats" class="loading" style="display: none;">No hay chats activos</div>
        </div>
        
        <div id="chatWindow" class="chat-window" style="display: none;">
            <div class="chat-header">
                <div>
                    <strong>Chat Activo (Cifrado)</strong>
                    <div id="chatIdDisplay" class="chat-id"></div>
                </div>
                <div id="chatStatus" class="status-indicator status-waiting"></div>
            </div>
            <div id="messagesContainer" class="messages-container"></div>
            <div class="input-area">
                <input type="text" id="messageInput" placeholder="Escribe tu mensaje cifrado..." disabled>
                <button id="sendMessageBtn" disabled>Enviar</button>
            </div>
        </div>

        <div id="noChatSelected" style="flex-grow: 1; display: flex; align-items: center; justify-content: center;">
            <div style="text-align: center; color: #666;">
                <h3>Selecciona un chat para comenzar</h3>
                <p>O crea un nuevo chat para compartir con un cliente</p>
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <!-- Librería de Cifrado -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

    <!-- Scripts de la Aplicación -->
    <script src="config.js"></script>
    <script src="crypto-helpers.js"></script>

    <script>
        // --- INICIALIZACIÓN Y AUTENTICACIÓN ---
        firebase.initializeApp(getFirebaseConfig());
        const db = firebase.database();
        const auth = firebase.auth();
        
        let selectedChatId = null;
        let chatsRef = null;

        // Guardia de Autenticación
        auth.onAuthStateChanged(user => {
            if (user) {
                // Si el usuario está autenticado, inicializa la app
                console.log("Agente autenticado:", user.email);
                initChatsListener();
            } else {
                // Si no, redirige a la página de login
                window.location.href = 'login.html';
            }
        });


        // --- ELEMENTOS DEL DOM ---
        const createChatBtn = document.getElementById('createChatBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const chatList = document.getElementById('chatList');
        const loadingChats = document.getElementById('loadingChats');
        const noChats = document.getElementById('noChats');
        const chatWindow = document.getElementById('chatWindow');
        const noChatSelected = document.getElementById('noChatSelected');
        const messagesContainer = document.getElementById('messagesContainer');
        const messageInput = document.getElementById('messageInput');
        const sendMessageBtn = document.getElementById('sendMessageBtn');
        const chatIdDisplay = document.getElementById('chatIdDisplay');
        const chatStatus = document.getElementById('chatStatus');

        // --- FUNCIONES PRINCIPALES ---
        createChatBtn.onclick = createNewChat;
        logoutBtn.onclick = () => auth.signOut();

        function createNewChat() {
            createChatBtn.disabled = true;
            createChatBtn.textContent = 'Creando...';
            
            const newChatRef = db.ref('chats').push();
            const chatId = newChatRef.key;
            
            // Crear estructura completa del chat
            const chatData = {
                metadata: { 
                    createdAt: Date.now(), 
                    status: 'waiting',
                    lastActivity: Date.now(),
                    unreadCount: 0,
                    agentJoined: false
                },
                messages: {} // Asegurar que existe el nodo messages
            };
            
            // Escribir en chatKeys PRIMERO
            db.ref(`chatKeys/${chatId}`).set(true)
            .then(() => {
                // Luego crear el chat
                return newChatRef.set(chatData);
            })
            .then(() => {
                const chatLink = `${window.location.origin}/chat.html?id=${chatId}`;
                // Usamos un modal custom en vez de confirm/alert
                showModal(`Chat creado exitosamente!\n\nEnlace: ${chatLink}`, () => {
                     navigator.clipboard.writeText(chatLink).then(() => console.log('Enlace copiado!'));
                });
                selectChat(chatId);
            }).catch(error => {
                console.error('Error creating chat:', error);
                alert('Error al crear el chat: ' + error.message);
            }).finally(() => {
                createChatBtn.disabled = false;
                createChatBtn.textContent = 'Crear Nuevo Chat';
            });
        }

        function initChatsListener() {
            chatsRef = db.ref('chats');
            chatsRef.orderByChild('metadata/lastActivity').limitToLast(50).on('value', (snapshot) => {
                loadingChats.style.display = 'none';
                const chats = snapshot.val();
                
                if (!chats || Object.keys(chats).length === 0) {
                    noChats.style.display = 'block';
                    chatList.style.display = 'none';
                    return;
                }
                
                noChats.style.display = 'none';
                chatList.style.display = 'block';
                updateChatList(chats);
            });
        }

        function updateChatList(chats) {
            chatList.innerHTML = '';
            const chatEntries = Object.entries(chats).sort((a, b) => 
                b[1].metadata.lastActivity - a[1].metadata.lastActivity
            );

            chatEntries.forEach(([chatId, chatData]) => {
                const chatItem = document.createElement('div');
                chatItem.className = 'chat-item';
                chatItem.dataset.chatId = chatId;
                
                const metadata = chatData.metadata || {};
                const unreadCount = metadata.unreadCount || 0;
                const status = metadata.status || 'waiting';
                const lastActivity = metadata.lastActivity || metadata.createdAt;
                
                chatItem.innerHTML = `
                    <div class="chat-info">
                        <span class="status-indicator status-${status}"></span>
                        <div>
                            <div>Chat: ${chatId.substring(0, 8)}...</div>
                            <div class="chat-meta">
                                ${formatTime(lastActivity)} • ${status}
                            </div>
                        </div>
                    </div>
                    ${unreadCount > 0 ? `<span class="badge">${unreadCount}</span>` : ''}
                `;
                
                chatItem.onclick = () => selectChat(chatId);
                if (chatId === selectedChatId) {
                    chatItem.classList.add('selected');
                }
                if (unreadCount > 0) {
                    chatItem.classList.add('unread');
                }
                
                chatList.appendChild(chatItem);
            });
        }

        function selectChat(chatId) {
            selectedChatId = chatId;
            
            document.querySelectorAll('.chat-item').forEach(el => {
                el.classList.remove('selected');
                if (el.dataset.chatId === chatId) {
                    el.classList.add('selected');
                    el.classList.remove('unread');
                }
            });
            
            chatWindow.style.display = 'flex';
            noChatSelected.style.display = 'none';
            chatIdDisplay.textContent = `ID: ${chatId}`;
            
            messageInput.disabled = false;
            sendMessageBtn.disabled = false;
            messageInput.focus();
            
            loadChatMessages(chatId);
            updateChatStatus(chatId);
            resetUnreadCount(chatId);
        }

        function loadChatMessages(chatId) {
            const messagesRef = db.ref(`chats/${chatId}/messages`);
            messagesRef.orderByChild('timestamp').on('value', (snapshot) => {
                messagesContainer.innerHTML = '';
                const messages = snapshot.val();
                
                if (!messages) {
                    messagesContainer.innerHTML = '<div class="loading">No hay mensajes aún</div>';
                    return;
                }
                
                const messagesArray = Object.entries(messages)
                    .sort((a, b) => a[1].timestamp - b[1].timestamp);
                
                messagesArray.forEach(([msgId, msg]) => {
                    addMessageToUI(msg.text, msg.sender, msg.timestamp);
                });
                
                scrollToBottom();
            });
        }

        function addMessageToUI(encryptedText, sender, timestamp) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            let plainText = '';

            try {
                // *** DESCIFRADO DEL MENSAJE ***
                plainText = decryptMessage(encryptedText, selectedChatId);
            } catch (e) {
                console.warn("No se pudo descifrar un mensaje:", e);
                plainText = "<i>[Mensaje no descifrable o antiguo]</i>";
            }
            
            const timeString = formatTime(timestamp, true);
            messageDiv.innerHTML = `
                ${plainText}
                <div class="message-time">${timeString}</div>
            `;
            
            messagesContainer.appendChild(messageDiv);
        }

        function sendMessage() {
            const text = messageInput.value.trim();
            if (!text || !selectedChatId) return;

            // *** CIFRADO DEL MENSAJE ***
            const encryptedText = encryptMessage(text, selectedChatId);
            
            const messagesRef = db.ref(`chats/${selectedChatId}/messages`);
            const timestamp = Date.now();
            
            messagesRef.push({
                text: encryptedText, // Guardamos el texto cifrado
                sender: 'agent',
                timestamp: timestamp
            }).then(() => {
                messageInput.value = '';
                db.ref(`chats/${selectedChatId}/metadata`).update({
                    lastActivity: timestamp,
                    status: 'active',
                    agentJoined: true,
                    unreadCount: 0
                });
            }).catch(error => {
                console.error('Error sending message:', error);
                alert('Error al enviar el mensaje');
            });
        }

        function resetUnreadCount(chatId) {
            db.ref(`chats/${chatId}/metadata/unreadCount`).set(0);
        }

        function updateChatStatus(chatId) {
            const metadataRef = db.ref(`chats/${chatId}/metadata`);
            metadataRef.on('value', (snapshot) => {
                const metadata = snapshot.val() || {};
                const status = metadata.status || 'waiting';
                chatStatus.className = `status-indicator status-${status}`;
                chatStatus.title = `Estado: ${status}`;
            });
        }

        // --- FUNCIONES DE UTILIDAD ---
        function formatTime(timestamp, includeTime = false) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            const now = new Date();
            const isToday = date.toDateString() === now.toDateString();
            if (isToday) {
                return date.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
            }
            return date.toLocaleDateString('es-ES');
        }

        function scrollToBottom() {
            setTimeout(() => messagesContainer.scrollTop = messagesContainer.scrollHeight, 100);
        }

        function showModal(message, onConfirm) {
            // Implementación simple de un modal para evitar `confirm()`
            const modalText = message + "\n\n¿Quieres copiar el enlace al portapapeles?";
            if (window.confirm(modalText)) {
                onConfirm();
            }
        }
        
        // --- EVENT LISTENERS ---
        sendMessageBtn.onclick = sendMessage;
        messageInput.onkeypress = (e) => { if (e.key === 'Enter') sendMessage(); };

    </script>
</body>
</html>
[file content end]